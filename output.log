2025-12-20 10:07:43 - lead_enrichment - INFO - Starting Lead Enrichment Engine
2025-12-20 10:07:43 - lead_enrichment - INFO - Input file: tests/m3_test_data.xlsx
2025-12-20 10:07:43 - lead_enrichment - INFO - Reading Excel file...
2025-12-20 10:07:43 - lead_enrichment - INFO - Reading Excel file: tests/m3_test_data.xlsx
2025-12-20 10:07:43 - lead_enrichment - INFO - Detecting red rows in tests/m3_test_data.xlsx
2025-12-20 10:07:43 - lead_enrichment - INFO - Found 0 red rows: []
2025-12-20 10:07:43 - lead_enrichment - INFO - Read 20 rows, 0 marked as red
2025-12-20 10:07:43 - lead_enrichment - INFO - DEBUG read_excel: returning metadata with keys: dict_keys(['red_row_indices', 'red_df_indices', 'original_columns', 'filepath'])
2025-12-20 10:07:43 - lead_enrichment - INFO - DEBUG read_excel: metadata type: <class 'dict'>
2025-12-20 10:07:43 - lead_enrichment - INFO - DEBUG read_excel: metadata is None? False
2025-12-20 10:07:43 - lead_enrichment - INFO - DEBUG read_excel: metadata keys: dict_keys(['red_row_indices', 'red_df_indices', 'original_columns', 'filepath'])
2025-12-20 10:07:43 - lead_enrichment - INFO - Core orchestrator: processing 20 rows (skipping 0 red rows)
2025-12-20 10:07:43 - lead_enrichment - INFO - Loading priority rules from /Users/matiaswas/Code/MVPs/lead-enrichment-engine/config/rules/priority_rules.yaml
2025-12-20 10:07:43 - lead_enrichment - INFO - Priority engine initialized
2025-12-20 10:07:43 - lead_enrichment - INFO - Calculating priorities for 20 rows
2025-12-20 10:07:43 - lead_enrichment - INFO - Priority distribution: {3: 11, 1: 4, 2: 4, 4: 1}
2025-12-20 10:07:43 - lead_enrichment - INFO - Running Tier1 validation (CIF/NIF/NIE + Phone)...
Tier1 validation:   0%|          | 0/20 [00:00<?, ?it/s]Tier1 validation: 100%|██████████| 20/20 [00:00<00:00, 6789.10it/s]
2025-12-20 10:07:43 - lead_enrichment - INFO - Running Tier1 enrichment (phone finder + company name)...
Tier1 enrichment:   0%|          | 0/20 [00:00<?, ?it/s]2025-12-20T10:07:43 CRITICAL tier1.rate_limiter Rate limit CRITICAL threshold reached | extra={'provider': 'google_places', 'used': 200, 'limit': 200}
2025-12-20T10:07:43 WARNING tier1.google_places Google Places rate limit exceeded, skipping call | extra={'company_name': 'Empresa A SL'}
2025-12-20T10:07:43 WARNING tier1.retry._fetch Retryable error, will retry | extra={'attempt': 1, 'error': 'HTTPSConnectionPool(host=\'nan\', port=443): Max retries exceeded with url: / (Caused by NameResolutionError("HTTPSConnection(host=\'nan\', port=443): Failed to resolve \'nan\' ([Errno 8] nodename nor servname provided, or not known)"))'}
2025-12-20T10:07:44 WARNING tier1.retry._fetch Retryable error, will retry | extra={'attempt': 2, 'error': 'HTTPSConnectionPool(host=\'nan\', port=443): Max retries exceeded with url: / (Caused by NameResolutionError("HTTPSConnection(host=\'nan\', port=443): Failed to resolve \'nan\' ([Errno 8] nodename nor servname provided, or not known)"))'}
2025-12-20T10:07:45 WARNING tier1.web_scraper Web scraper failed to fetch website | extra={'website': 'nan', 'error': 'HTTPSConnectionPool(host=\'nan\', port=443): Max retries exceeded with url: / (Caused by NameResolutionError("HTTPSConnection(host=\'nan\', port=443): Failed to resolve \'nan\' ([Errno 8] nodename nor servname provided, or not known)"))'}
Tier1 enrichment:   5%|▌         | 1/20 [00:01<00:29,  1.53s/it]2025-12-20T10:07:45 CRITICAL tier1.rate_limiter Rate limit CRITICAL threshold reached | extra={'provider': 'google_places', 'used': 200, 'limit': 200}
2025-12-20T10:07:45 WARNING tier1.google_places Google Places rate limit exceeded, skipping call | extra={'company_name': 'Empresa B SA'}
Tier1 enrichment:  10%|█         | 2/20 [00:02<00:16,  1.08it/s]2025-12-20T10:07:45 CRITICAL tier1.rate_limiter Rate limit CRITICAL threshold reached | extra={'provider': 'google_places', 'used': 200, 'limit': 200}
2025-12-20T10:07:45 WARNING tier1.google_places Google Places rate limit exceeded, skipping call | extra={'company_name': 'Empresa C SLU'}
2025-12-20T10:07:45 WARNING tier1.retry._fetch Retryable error, will retry | extra={'attempt': 1, 'error': 'HTTPSConnectionPool(host=\'nan\', port=443): Max retries exceeded with url: / (Caused by NameResolutionError("HTTPSConnection(host=\'nan\', port=443): Failed to resolve \'nan\' ([Errno 8] nodename nor servname provided, or not known)"))'}
2025-12-20T10:07:46 WARNING tier1.retry._fetch Retryable error, will retry | extra={'attempt': 2, 'error': 'HTTPSConnectionPool(host=\'nan\', port=443): Max retries exceeded with url: / (Caused by NameResolutionError("HTTPSConnection(host=\'nan\', port=443): Failed to resolve \'nan\' ([Errno 8] nodename nor servname provided, or not known)"))'}
2025-12-20T10:07:47 WARNING tier1.web_scraper Web scraper failed to fetch website | extra={'website': 'nan', 'error': 'HTTPSConnectionPool(host=\'nan\', port=443): Max retries exceeded with url: / (Caused by NameResolutionError("HTTPSConnection(host=\'nan\', port=443): Failed to resolve \'nan\' ([Errno 8] nodename nor servname provided, or not known)"))'}
Tier1 enrichment:  15%|█▌        | 3/20 [00:03<00:20,  1.20s/it]2025-12-20T10:07:47 CRITICAL tier1.rate_limiter Rate limit CRITICAL threshold reached | extra={'provider': 'google_places', 'used': 200, 'limit': 200}
2025-12-20T10:07:47 WARNING tier1.google_places Google Places rate limit exceeded, skipping call | extra={'company_name': 'Empresa D SL'}
2025-12-20T10:07:47 WARNING tier1.retry._fetch Retryable error, will retry | extra={'attempt': 1, 'error': 'HTTPSConnectionPool(host=\'nan\', port=443): Max retries exceeded with url: / (Caused by NameResolutionError("HTTPSConnection(host=\'nan\', port=443): Failed to resolve \'nan\' ([Errno 8] nodename nor servname provided, or not known)"))'}
2025-12-20T10:07:48 WARNING tier1.retry._fetch Retryable error, will retry | extra={'attempt': 2, 'error': 'HTTPSConnectionPool(host=\'nan\', port=443): Max retries exceeded with url: / (Caused by NameResolutionError("HTTPSConnection(host=\'nan\', port=443): Failed to resolve \'nan\' ([Errno 8] nodename nor servname provided, or not known)"))'}
2025-12-20T10:07:49 WARNING tier1.web_scraper Web scraper failed to fetch website | extra={'website': 'nan', 'error': 'HTTPSConnectionPool(host=\'nan\', port=443): Max retries exceeded with url: / (Caused by NameResolutionError("HTTPSConnection(host=\'nan\', port=443): Failed to resolve \'nan\' ([Errno 8] nodename nor servname provided, or not known)"))'}
Tier1 enrichment:  20%|██        | 4/20 [00:05<00:21,  1.33s/it]2025-12-20T10:07:49 CRITICAL tier1.rate_limiter Rate limit CRITICAL threshold reached | extra={'provider': 'google_places', 'used': 200, 'limit': 200}
2025-12-20T10:07:49 WARNING tier1.google_places Google Places rate limit exceeded, skipping call | extra={'company_name': 'Empresa E SA'}
2025-12-20T10:07:59 WARNING tier1.retry._fetch Retryable error, will retry | extra={'attempt': 1, 'error': "HTTPSConnectionPool(host='another.com', port=443): Max retries exceeded with url: / (Caused by ConnectTimeoutError(<HTTPSConnection(host='another.com', port=443) at 0x10cf538c0>, 'Connection to another.com timed out. (connect timeout=10)'))"}
2025-12-20T10:08:09 WARNING tier1.retry._fetch Retryable error, will retry | extra={'attempt': 2, 'error': "HTTPSConnectionPool(host='another.com', port=443): Max retries exceeded with url: / (Caused by ConnectTimeoutError(<HTTPSConnection(host='another.com', port=443) at 0x10cf53080>, 'Connection to another.com timed out. (connect timeout=10)'))"}
Tier1 enrichment:  20%|██        | 4/20 [00:26<01:45,  6.58s/it]
Traceback (most recent call last):
  File "/Users/matiaswas/Code/MVPs/lead-enrichment-engine/.venv/lib/python3.12/site-packages/urllib3/connection.py", line 204, in _new_conn
    sock = connection.create_connection(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/matiaswas/Code/MVPs/lead-enrichment-engine/.venv/lib/python3.12/site-packages/urllib3/util/connection.py", line 85, in create_connection
    raise err
  File "/Users/matiaswas/Code/MVPs/lead-enrichment-engine/.venv/lib/python3.12/site-packages/urllib3/util/connection.py", line 73, in create_connection
    sock.connect(sa)
TimeoutError: timed out

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/matiaswas/Code/MVPs/lead-enrichment-engine/.venv/lib/python3.12/site-packages/urllib3/connectionpool.py", line 787, in urlopen
    response = self._make_request(
               ^^^^^^^^^^^^^^^^^^^
  File "/Users/matiaswas/Code/MVPs/lead-enrichment-engine/.venv/lib/python3.12/site-packages/urllib3/connectionpool.py", line 488, in _make_request
    raise new_e
  File "/Users/matiaswas/Code/MVPs/lead-enrichment-engine/.venv/lib/python3.12/site-packages/urllib3/connectionpool.py", line 464, in _make_request
    self._validate_conn(conn)
  File "/Users/matiaswas/Code/MVPs/lead-enrichment-engine/.venv/lib/python3.12/site-packages/urllib3/connectionpool.py", line 1093, in _validate_conn
    conn.connect()
  File "/Users/matiaswas/Code/MVPs/lead-enrichment-engine/.venv/lib/python3.12/site-packages/urllib3/connection.py", line 759, in connect
    self.sock = sock = self._new_conn()
                       ^^^^^^^^^^^^^^^^
  File "/Users/matiaswas/Code/MVPs/lead-enrichment-engine/.venv/lib/python3.12/site-packages/urllib3/connection.py", line 213, in _new_conn
    raise ConnectTimeoutError(
urllib3.exceptions.ConnectTimeoutError: (<HTTPSConnection(host='another.com', port=443) at 0x10cf53080>, 'Connection to another.com timed out. (connect timeout=10)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/matiaswas/Code/MVPs/lead-enrichment-engine/.venv/lib/python3.12/site-packages/requests/adapters.py", line 644, in send
    resp = conn.urlopen(
           ^^^^^^^^^^^^^
  File "/Users/matiaswas/Code/MVPs/lead-enrichment-engine/.venv/lib/python3.12/site-packages/urllib3/connectionpool.py", line 841, in urlopen
    retries = retries.increment(
              ^^^^^^^^^^^^^^^^^^
  File "/Users/matiaswas/Code/MVPs/lead-enrichment-engine/.venv/lib/python3.12/site-packages/urllib3/util/retry.py", line 519, in increment
    raise MaxRetryError(_pool, url, reason) from reason  # type: ignore[arg-type]
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
urllib3.exceptions.MaxRetryError: HTTPSConnectionPool(host='another.com', port=443): Max retries exceeded with url: / (Caused by ConnectTimeoutError(<HTTPSConnection(host='another.com', port=443) at 0x10cf53080>, 'Connection to another.com timed out. (connect timeout=10)'))

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/matiaswas/Code/MVPs/lead-enrichment-engine/src/api_manager/utils/retry.py", line 34, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/matiaswas/Code/MVPs/lead-enrichment-engine/src/api_manager/enrichers/phone/web_scraper.py", line 61, in _fetch
    resp = requests.get(
           ^^^^^^^^^^^^^
  File "/Users/matiaswas/Code/MVPs/lead-enrichment-engine/.venv/lib/python3.12/site-packages/requests/api.py", line 73, in get
    return request("get", url, params=params, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/matiaswas/Code/MVPs/lead-enrichment-engine/.venv/lib/python3.12/site-packages/requests/api.py", line 59, in request
    return session.request(method=method, url=url, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/matiaswas/Code/MVPs/lead-enrichment-engine/.venv/lib/python3.12/site-packages/requests/sessions.py", line 589, in request
    resp = self.send(prep, **send_kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/matiaswas/Code/MVPs/lead-enrichment-engine/.venv/lib/python3.12/site-packages/requests/sessions.py", line 703, in send
    r = adapter.send(request, **kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/matiaswas/Code/MVPs/lead-enrichment-engine/.venv/lib/python3.12/site-packages/requests/adapters.py", line 665, in send
    raise ConnectTimeout(e, request=request)
requests.exceptions.ConnectTimeout: HTTPSConnectionPool(host='another.com', port=443): Max retries exceeded with url: / (Caused by ConnectTimeoutError(<HTTPSConnection(host='another.com', port=443) at 0x10cf53080>, 'Connection to another.com timed out. (connect timeout=10)'))

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/matiaswas/Code/MVPs/lead-enrichment-engine/src/main.py", line 162, in <module>
    main()
  File "/Users/matiaswas/Code/MVPs/lead-enrichment-engine/src/main.py", line 85, in main
    df_result, batch_report = run_pipeline(
                              ^^^^^^^^^^^^^
  File "/Users/matiaswas/Code/MVPs/lead-enrichment-engine/src/core/orchestrator.py", line 127, in run_pipeline
    batch_report = enricher.enrich_batch(records)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/matiaswas/Code/MVPs/lead-enrichment-engine/src/api_manager/tier1_enricher.py", line 200, in enrich_batch
    enriched = self.enrich_lead(lead)
               ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/matiaswas/Code/MVPs/lead-enrichment-engine/src/api_manager/tier1_enricher.py", line 114, in enrich_lead
    phone_result = self.phone_finder_fallback.find(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/matiaswas/Code/MVPs/lead-enrichment-engine/src/api_manager/enrichers/phone/web_scraper.py", line 74, in find
    html = self._fetch(website)
           ^^^^^^^^^^^^^^^^^^^^
  File "/Users/matiaswas/Code/MVPs/lead-enrichment-engine/src/api_manager/utils/retry.py", line 44, in wrapper
    time.sleep(delay)
KeyboardInterrupt
